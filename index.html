<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Workout</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0a;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            padding: 1rem;
            transition: background 0.3s ease;
        }

        body.correct {
            background: #0a1a0a;
        }

        #settings {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0.3;
            transition: opacity 0.2s;
        }

        #settings:hover {
            opacity: 1;
        }

        .digit-selector, .op-selector {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #888;
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            outline: none;
        }

        .digit-selector:focus, .op-selector:focus {
            border-color: #555;
        }

        #question {
            font-size: clamp(2.5rem, 8vw, 4rem);
            font-weight: 300;
            letter-spacing: 0.05em;
            transition: transform 0.2s ease;
        }

        #question.new {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #answer {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #ffffff;
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            padding: 1rem 1.5rem;
            text-align: center;
            width: min(300px, 80vw);
            border-radius: 8px;
            outline: none;
            transition: all 0.2s ease;
        }

        #answer:focus {
            border-color: #555;
        }

        #answer.wrong {
            background: #3a1a1a;
            border-color: #aa3333;
            animation: shake 0.3s ease;
        }

        #answer.correct {
            border-color: #33aa33;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        #streak {
            position: absolute;
            bottom: 2rem;
            font-size: 0.9rem;
            color: #333;
            transition: all 0.3s ease;
        }

        #streak.active {
            color: #666;
        }

        #streak.high {
            color: #aa8833;
            font-weight: 500;
        }

        #time {
            position: absolute;
            top: 1rem;
            left: 1rem;
            font-size: 0.8rem;
            color: #333;
            font-variant-numeric: tabular-nums;
        }

        .key-hint {
            position: absolute;
            bottom: 0.5rem;
            right: 1rem;
            font-size: 0.7rem;
            color: #222;
        }

        /* Hide spinner arrows */
        #answer::-webkit-outer-spin-button,
        #answer::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        #answer[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>
    <div id="time"></div>
    
    <div id="settings">
        <select id="op" class="op-selector">
            <option value="×">×</option>
            <option value="+">+</option>
            <option value="-">−</option>
            <option value="÷">÷</option>
            <option value="mix">mix</option>
        </select>
        <select id="digits1" class="digit-selector">
            <option value="1">1d</option>
            <option value="2">2d</option>
            <option value="3">3d</option>
        </select>
        <select id="digits2" class="digit-selector">
            <option value="1">1d</option>
            <option value="2">2d</option>
            <option value="3">3d</option>
        </select>
    </div>

    <div id="question"></div>
    <input type="number" id="answer" inputmode="numeric" autocomplete="off">
    
    <div id="streak">0</div>
    <div class="key-hint">↵ skip</div>

    <script>
        let a, b, correctAnswer, operation;
        let digits1 = 1;
        let digits2 = 1;
        let selectedOp = '×';
        let streak = 0;
        let bestStreak = localStorage.getItem('bestStreak') || 0;
        let startTime = Date.now();
        let questionStartTime = Date.now();
        let fastestTime = Infinity;

        function getRandomNumber(digits) {
            const min = digits === 1 ? 1 : Math.pow(10, digits - 1);
            const max = Math.pow(10, digits) - 1;
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getOperation() {
            if (selectedOp === 'mix') {
                const ops = ['×', '+', '-', '÷'];
                return ops[Math.floor(Math.random() * ops.length)];
            }
            return selectedOp;
        }

        function generateQuestion() {
            a = getRandomNumber(digits1);
            b = getRandomNumber(digits2);
            operation = getOperation();
            
            // Adjust for division to avoid decimals
            if (operation === '÷') {
                correctAnswer = b;
                a = b * getRandomNumber(digits1);
            } else {
                switch(operation) {
                    case '×': correctAnswer = a * b; break;
                    case '+': correctAnswer = a + b; break;
                    case '-': 
                        // Ensure positive result
                        if (a < b) [a, b] = [b, a];
                        correctAnswer = a - b; 
                        break;
                }
            }
            
            const questionEl = document.getElementById('question');
            questionEl.textContent = `${a} ${operation} ${b}`;
            questionEl.classList.remove('new');
            void questionEl.offsetWidth; // Force reflow
            questionEl.classList.add('new');
            
            questionStartTime = Date.now();
        }

        function updateStreak(correct) {
            if (correct) {
                streak++;
                if (streak > bestStreak) {
                    bestStreak = streak;
                    localStorage.setItem('bestStreak', bestStreak);
                }
            } else {
                streak = 0;
            }
            
            const streakEl = document.getElementById('streak');
            if (streak > 0) {
                streakEl.textContent = streak;
                streakEl.classList.add('active');
                if (streak === bestStreak && streak > 5) {
                    streakEl.classList.add('high');
                }
            } else {
                streakEl.textContent = '0';
                streakEl.classList.remove('active', 'high');
            }
        }

        function flashBackground() {
            document.body.classList.add('correct');
            setTimeout(() => document.body.classList.remove('correct'), 200);
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('time').textContent = 
                mins > 0 ? `${mins}:${secs.toString().padStart(2, '0')}` : `${secs}s`;
        }

        const input = document.getElementById('answer');
        const d1Select = document.getElementById('digits1');
        const d2Select = document.getElementById('digits2');
        const opSelect = document.getElementById('op');

        d1Select.addEventListener('change', function() {
            digits1 = parseInt(this.value);
            input.value = '';
            input.classList.remove('wrong', 'correct');
            generateQuestion();
            input.focus();
        });

        d2Select.addEventListener('change', function() {
            digits2 = parseInt(this.value);
            input.value = '';
            input.classList.remove('wrong', 'correct');
            generateQuestion();
            input.focus();
        });

        opSelect.addEventListener('change', function() {
            selectedOp = this.value;
            input.value = '';
            input.classList.remove('wrong', 'correct');
            generateQuestion();
            input.focus();
        });

        input.addEventListener('input', function() {
            const userAnswer = parseInt(this.value);
            
            if (this.value && userAnswer === correctAnswer) {
                const timeToAnswer = Date.now() - questionStartTime;
                if (timeToAnswer < fastestTime) {
                    fastestTime = timeToAnswer;
                }
                
                this.classList.add('correct');
                updateStreak(true);
                flashBackground();
                
                setTimeout(() => {
                    this.value = '';
                    this.classList.remove('wrong', 'correct');
                    generateQuestion();
                }, 150);
            } else if (this.value && userAnswer !== correctAnswer && this.value.length >= correctAnswer.toString().length) {
                this.classList.add('wrong');
                updateStreak(false);
                setTimeout(() => {
                    this.value = '';
                    this.classList.remove('wrong');
                }, 300);
            }
        });

        // Skip question on Enter with empty input
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && this.value === '') {
                updateStreak(false);
                generateQuestion();
            }
        });

        // Initialize
        generateQuestion();
        input.focus();
        setInterval(updateTimer, 1000);

        // Keep focus on mobile
        input.addEventListener('blur', function(e) {
            if (!e.relatedTarget || (!e.relatedTarget.classList.contains('digit-selector') && !e.relatedTarget.classList.contains('op-selector'))) {
                setTimeout(() => this.focus(), 10);
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'r' && e.metaKey) {
                e.preventDefault();
                streak = 0;
                updateStreak(false);
                generateQuestion();
            }
        });
    </script>
</body>
</html>